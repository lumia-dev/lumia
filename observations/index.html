<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://lumia.nateko.lu.se/observations/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Observations - LUMIA</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">LUMIA</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Modules <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active">Observations</a>
</li>
                                    
<li>
    <a href="../prior/" class="dropdown-item">Prior uncertainties</a>
</li>
                                    
<li>
    <a href="../data/" class="dropdown-item">Emissions</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href=".." class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../prior/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/lumia-dev/lumia/edit/omegaconf/docs/observations.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#observations" class="nav-link">Observations</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#structure" class="nav-link">Structure</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#construction" class="nav-link">Construction</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#io-and-file-formats" class="nav-link">I/O and file formats</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#other-methods" class="nav-link">Other methods:</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="observations">Observations</h1>
<p>The <code>lumia.observations</code> module provides classes to store data in the observations space (observation vector, observation uncertainties, observation coordinates, model estimates for concentrations, etc.).</p>
<details class="note" open="open">
<summary>Modularity</summary>
<p>The design of the observations class depends, to some extent, of the type of observations (e.g. in-situ observations vs. satellite observations) and of the type of transport model (what metadata needs to be stored?).</p>
<p>This document describes the default class (<code>lumia.Observations</code>, a.k.a. <code>lumia.observations.observations.Observations</code>). It is designed for handling in-situ data, and for use with the default <a href="transport-module.md"><code>lumia.Transport</code></a> class.</p>
</details>
<h2 id="structure">Structure</h2>
<p>The <code>Observations</code> object contains two main data attributes:</p>
<ul>
<li><code>sites</code> (<em>pandas.DataFrame</em>) contains information on observation series: site name and code, coordinates (if relevant), observation type, data provider, DOI, etc.</li>
<li><code>observations</code> (<em>pandas.DataFrame</em>) contains information on the observation themselves: observed concentrations, estimated uncertainties, coordinates, etc.)</li>
</ul>
<p>The <code>Observations</code> class also implements a few methods:</p>
<ul>
<li>I/O methods, to read and write the observations to various file formats (HDF, tar.gz)</li>
<li>selection methods, to refine the data selection and extract a subset of the observations.</li>
<li><code>calc_uncertainty</code>: a method to estimate the observation uncertainties (i.e. combine the measurement uncertainty with an estimate of the model uncertainty).</li>
</ul>
<p>Finally, the <code>Observation</code> objects have two "properties" (attributes): <code>mismatch</code> and <code>sigma</code>, which contain respectively the model-data mismatches (model - obs) and the uncertainty (1<span class="arithmatex">\(\sigma\)</span>) on them. These attributes are accessed by the optimizer.</p>
<h2 id="construction">Construction</h2>
<p>The simplest way to create a new <code>Observations</code> object is to construct first its <code>sites</code> and <code>observations</code> tables:</p>
<ul>
<li>The <code>Observations.sites</code> table contain information common to a whole observation series. For instance, the site name and coordinates, sitecode, tracer, units, data provider, DOI, source file, etc. There is no specific or mandatory list of columns, the table is here for the user convenience.</li>
<li>The <code>Observations.observations</code> table contains the observations themselves, their uncertainties, relevant metadata (time, sampling height, etc.) and more generally any data in the observation space that may be required by the model (e.g. path to pre-computed observation footprints) or that it may be worth storing. It is also where modelled values will be stored. The <code>observations</code> table has a few mandatory or recommended columns:<ul>
<li><strong>obs</strong>: the observed concentrations</li>
<li><strong>err</strong>: the total observation uncertainty (i.e. uncertainty on the model-data mismatch, including both the observation uncertainty and the model uncertainty)</li>
<li><strong>time</strong>: the observation time</li>
<li><strong>height</strong>: the sampling height (above ground) of the observations</li>
<li><strong>code</strong>: the site code</li>
<li><strong>site</strong>: the index of the relevant row in the <code>Observations.sites</code> table</li>
<li><strong>mix_background</strong>: the background concentrations (i.e. boundary condition).</li>
</ul>
</li>
</ul>
<p>One way to see it is that the "observations" table stores what is usually the data part of an observation files (i.e. the columns in a CSV file, or the variables in a netCDF file), whereas the "sites" table stores the metadata (header in a CSV file, attributes in a netCDF file).</p>
<p>The code below shows a partial example for importing a bunch of files (in this example, ICOS CSV files) to a <code>lumia.Observations</code> object, and finally storing that object as a <strong>tar.gz</strong> file:</p>
<pre class="highlight"><code class="language-python">from pathlib import Path
from pandas import DataFrame, read_csv, concat
from lumia import Observations

def import_csv_icos(filename : Path) -&gt; (dict, DataFrame):
    """
    A function that reads one ICOS observation file (in CSV format), and returns:
    - metadata: a dictionary containing the elements that should go in the `Observations.sites` table
    - data: a DataFrame containing the section of the `Observations.observations` table corresponding to this file
    """
    ...
    return metadata, data

# Create temporary lists to store the imported data
sites, observations = [], []

# Loop over the files (look for every file matching the "/path/to/observations/co2*.csv" pattern
for filepath in Path('/path/to/observations').glob('ICOS_ATC_*.CO2'):
    site, obs = import_csv_icos(filepath)
    sites.append(site)
    observations.append(obs)

# Concatenate the sites and observations lists in two DataFrames:
sites = concat(sites)
observations = concat(observations)

# Create the actual lumia.Observations object
obs = Observations(sites=sites, observations=observations)

# Store it to disk:
obs.save_tar('observations.tar.gz') 
</code></pre>
<h2 id="io-and-file-formats">I/O and file formats</h2>
<p>The <code>Observations</code> class can read and write to two different file formats:</p>
<ul>
<li><strong>tar.gz</strong> files are the default file format. The <em>sites</em> and <em>observations</em> tables are simply written out as CSV files, and clobbed together in a gzip-compressed tar files. The main advantage of that format is that it remains human-readable (one only needs to uncompress the tar.gz file). On the other hand, it is not very fast.</li>
<li><strong>hdf</strong> files are also used internally, for communication with the <a href="transport_pkg.md"><code>transport</code> package</a>.</li>
</ul>
<p>The <strong>tar.gz</strong> format is the recommended one for day-to-day interactions:</p>
<pre class="highlight"><code class="language-python">import lumia

# Read an observation file in tar.gz format:
obs = lumia.Observations.from_tar('observations.tar.gz')

# Write an Observations object to a file:
obs.save_tar('observations.tar.gz')</code></pre>
<h2 id="other-methods">Other methods:</h2>
<p>The list may not be complete: refer to the actual code for further information.</p>
<ul>
<li><code>Observations.calc_uncertainties</code>: Compute an estimate of the uncertainties in the observation space, combining the measurement uncertainty and model uncertainty. The method is called at the end of the first forward iteration, as it (may) need the prior model estimates for the observations. See documentation in the code for further details. The method may need an additional <code>settings</code> attribute to be defined.</li>
<li><code>Observations.select_times</code>: when provided with a list of sites (indices of the <code>Observations.sites</code> table), returns a new <code>Observations</code> object, containing only data for these sites.</li>
<li><code>Observations.select_sites</code>: returns a new <code>Observations</code> object, limited to the provided range of dates.</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../javascripts/mathjax.js"></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
