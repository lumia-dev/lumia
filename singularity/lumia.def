Bootstrap: library
From: default/ubuntu:20.04

%post

    # Install packages

    apt-get -y update
    apt-get -y upgrade

    # Universe is needed for python packages:
    apt -y install software-properties-common
    add-apt-repository universe

    apt -y install vim htop
    apt -y install git
    apt -y install python3-pip python3-cartopy python3-matplotlib python3-h5py python3-pandas python3-netcdf4 python3-tqdm python3-xarray ipython3
    apt -y install rclone
    apt -y install netcdf-bin libnetcdff-dev libgeos-dev

    # Fix libgeos path:
    ln -s /usr/lib/x86_64-linux-gnu/libgeos_c.so /usr/lib/

    # Install LUMIA
    cd /lumia
    pip install -e .

    # Make congrad
    cd /lumia/src/congrad
    rm -f *.{mod,o}
    make congrad.exe
    mv congrad.exe /lumia/bin

%files
    ../. /lumia

%environment
    export machine=singularity

%runscript
    if [ $# -ne 0 ]
    then
        python3 /runflex/singularity/runscript.py $@
    else
        /bin/bash
    fi