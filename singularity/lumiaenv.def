Bootstrap: docker
From: ubuntu:20.04

%post

    # Install packages

    apt-get -y update
    apt-get -y upgrade

    # Universe is needed for python packages:
    apt -y install software-properties-common
    add-apt-repository universe

    apt -y install git rclone wget vim htop make gfortran
    apt -y install netcdf-bin libnetcdff-dev libgeos-dev

    # Install conda
    cd /opt
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
    chmod +x miniconda.sh
    ./miniconda.sh -b -p /opt/conda

    # Create a conda environment and make sure it is automatically activated
    . /opt/conda/etc/profile.d/conda.sh
    conda create -y -n lumia
    conda activate lumia
    conda install -y cartopy matplotlib h5py pandas netcdf4 tqdm xarray ipython pytables loguru
    export LC_ALL=C
    echo ". /opt/conda/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT
    echo "conda activate lumia" >> $SINGULARITY_ENVIRONMENT

    # Make directories
    mkdir /lumia

    # Make congrad
    cd /congrad
    rm -f *.{mod,o}
    make congrad.exe
    mv congrad.exe /usr/bin

    # Pre-install python package:
    export PYPTH=/opt/conda/envs/lumia/lib/python3.9/site-packages
    echo /lumia >> $PYPTH/easy-install.pth
    echo /lumia >> $PYPTH/lumia.egg-link


%files
    ../src/congrad /congrad

%environment
    export machine=singularity

%runscript
    if [ $# -ne 0 ]
    then
        python3 /lumia/singularity/runscript.py $@
    else
        /bin/bash
    fi
